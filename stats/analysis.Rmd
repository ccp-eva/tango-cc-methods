---
title: "Tango-cc analysis"
author: "Julia Prein"
date: "10/27/2023"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_packages, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse) # data handling etc.
library(tidybayes) # for stat_halfeye, add_predictive_draws
library(tidyboot) # for bootstrapped CIs
library(brms) # modeling
library(cmdstanr) # modeling
library(janitor) # clean_names
library(ggpubr) # ggarrange
library(splithalfr) # split half reliability
library(ggridges) # for ridge plot

options(scipen = 999)
theme_set(theme_classic())

# Seed for random number generation
set.seed(42)
```

```{r load_data}
data <- read_csv("../data/data.csv") 

mdata <- read_csv("../data/data.csv")%>%
  group_by(subjid, community, age_group, ageinyears)%>%
  summarise(impr = mean(abs(clickdistfromtargetcenterx)))%>%
  ungroup()%>%
  mutate(age = scale(ageinyears))
```

```{r sample}
# full sample
data %>%
  group_by(subjid) %>%
  summarise(n= n())%>%
  arrange(n)

data %>%
  group_by(community, age_group) %>%
  summarise(n= n_distinct(subjid))

data %>%
  group_by(community) %>%
  summarise(n= n_distinct(subjid))

data %>%
  summarise(n= n_distinct(subjid))

# model data
mdata %>%
  group_by(community, age_group) %>%
  summarise(n= n_distinct(subjid))

mdata %>%
  group_by(community) %>%
  summarise(n= n_distinct(subjid))

mdata %>% ungroup() %>% 
  summarise(n= n_distinct(subjid))
```

# Internal consistency

```{r}
# children who did not finish all trials are removed (only 5 children total)

exclude <- data %>%
  group_by(subjid) %>%
  summarise(n= n())%>%
  filter(n < 15)%>%
  pull(subjid)

reli_data <- data%>%
  filter(!subjid %in% exclude)%>%
  mutate(pos_cent = as.character(abs(5-targetposition)))
```

## Odd-even

```{r}
reli_data%>%
  mutate(half = ifelse(trialnr %% 2 == 0, "half_1", "half_2"))%>%
  group_by(subjid, community, half)%>%
  summarise(impr = mean(abs(clickdistfromtargetcenterx)))%>%
  pivot_wider(names_from = half, values_from = impr)%>%
  group_by(community)%>%
  summarise(reli = cor(half_1, half_2))%>%
  ggplot(aes(x = reli, y = community))+
  geom_vline(xintercept = 0, lty = 3, alpha = .75)+
  geom_point(alpha = .5)+
  #geom_pointrange(aes(xmin = lci, xmax = uci))+
  scale_x_continuous(limits = c(-0.5, 1), breaks = c(-0.5, 0, 0.5, 0.6,0.7, 0.8, 0.9, 1))+
  ggtitle("Simple odd-even split")+
  theme_minimal()
```


## Stratified by target position (categorical target centrality)

```{r}
# fn_mean <- function(ds) {
#   return(mean(abs(ds$clickdistfromtargetcenterx), na.rm = TRUE))
# }
# 
# #rel <- tibble()
# 
# communities <- unique(data$community)
# 
# for (j in c(21:50)) {
# 
# for (i in communities) {
#   
# # stratified by target position
# rel_s <- by_split(
#   data = reli_data %>% filter(community == i),
#   participants = reli_data %>% filter(community == i) %>% pull(subjid),
#   fn_score = fn_mean,
#   verbose = F,
#   stratification = paste(reli_data %>% filter(community == i) %>% pull(pos_cent)),
#   careful = FALSE
# )
# 
# samp <- tibble(
#   community = i,
#   iter = j,
#   reli = split_coefs(rel_s, cor),
#   lci = split_ci(rel_s, cor)$lims["0.025","bca"],
#   uci = split_ci(rel_s, cor)$lims["0.975","bca"]
#   )
# 
# rel <- bind_rows(rel, samp)
# 
# }
# 
# }
# 
# saveRDS(rel, "../saves/stratified_internal_consistency.rds")

rel <- readRDS("../saves/stratified_internal_consistency.rds")

```

```{r}
ggplot(rel, aes(x = reli, y = community))+
  geom_vline(xintercept = 0, lty = 3, alpha = .75)+
  geom_density_ridges(col = "white", alpha = .5,rel_min_height = 0.01,)+
  geom_point(alpha = .5)+
  #geom_pointrange(aes(xmin = lci, xmax = uci))+
  scale_x_continuous(limits = c(-0.5, 1), breaks = c(-0.5, 0, 0.5, 0.6,0.7, 0.8, 0.9, 1))+
  ggtitle("Stratified by target position - no age correction")+
  theme_minimal()
```

## Stratefied and age-corrected

```{r}
# # estimate age-corrected reliability
# # run model first for one community to use update()
# split <- split_df(
#   data = reli_data %>% filter(community == "leipzig"),
#   stratification = reli_data %>% filter(community == "leipzig") %>% pull(pos_cent),
#   careful = FALSE
# )
# 
# sdata <- bind_rows(
#   split[[1]]%>%select(subjid, ageinyears, clickdistfromtargetcenterx)%>%mutate(impr = abs(clickdistfromtargetcenterx), half = "half_1"),
#   split[[2]]%>%select(subjid, ageinyears, clickdistfromtargetcenterx)%>%mutate(impr = abs(clickdistfromtargetcenterx), half = "half_2"))%>%
#   mutate(age = scale(ageinyears))
# 
# reli_age <- brm(impr ~ age + (0 + half | subjid), 
#                 data   = sdata, 
#                 family = lognormal(), 
#                 warmup = 1000, 
#                 iter   = 3000,
#                 control = list(adapt_delta = 0.95),
#                 chains = 4,
#                 cores  = 4)
# 
# # loop over communities
# 
# communities <- unique(data$community)
# 
# #model_cor <- tibble()
# 
# for (j in c(21:50)) {
#   
# for (i in communities) {
#   
# com_split <- split_df(
#   data = reli_data %>% filter(community == i),
#   stratification = reli_data %>% filter(community == i) %>% pull(pos_cent),
#   careful = FALSE
#   )
# 
# com_sdata <- bind_rows(
#   com_split[[1]]%>%select(subjid, ageinyears, clickdistfromtargetcenterx)%>%mutate(impr = abs(clickdistfromtargetcenterx), half = "half_1"),
#   com_split[[2]]%>%select(subjid, ageinyears, clickdistfromtargetcenterx)%>%mutate(impr = abs(clickdistfromtargetcenterx), half = "half_2"))%>%
#   mutate(age = scale(ageinyears))
#  
# com_mod <-  update(reli_age,
#         newdata = com_sdata,
#         warmup = 1000, 
#         iter   = 3000,
#         control = list(adapt_delta = 0.95),
#         chains = 4,
#         cores  = 4)
#   
#   cor <- summary(com_mod)$random$subjid%>%as_tibble(rownames = "parameter")%>%filter(parameter == "cor(halfhalf_1,halfhalf_2)")%>%mutate(community = i, iter = j)
# 
#   model_cor <- bind_rows(model_cor, cor)
#   
#   
#   }
#   
# }
# 
# saveRDS(model_cor, "../saves/age_corrected_internal_consistency.rds")

model_cor <- readRDS("../saves/age_corrected_internal_consistency.rds")  
```

```{r}

ggplot(model_cor, aes(x = Estimate, y = community))+
  geom_vline(xintercept = 0, lty = 3, alpha = .75)+
  geom_density_ridges(col = "white", alpha = .5, rel_min_height = 0.01,)+
  geom_point(alpha = .5)+
  #geom_pointrange(aes(xmin = `l-95% CI`, xmax = `u-95% CI`), alpha = .5)+
  ggtitle("Stratified by target position - model-based age correction")+
  scale_x_continuous(limits = c(-1, 1), breaks = c(-0.5, 0, 0.5, 0.6,0.7, 0.8, 0.9, 1))+
  theme_minimal()

```

